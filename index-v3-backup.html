<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UVM FabLab — 3D Printer Scheduler</title>
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --uvm-green:      #154734;
      --uvm-green-dark: #0d2e22;
      --uvm-green-mid:  #1d5c42;
      --uvm-gold:       #F5B800;
      --white:          #ffffff;
      --off-white:      #f4f5f0;
      --border:         #d6d9d0;
      --text:           #1a1a1a;
      --muted:          #5a6357;
      --red:            #b91c1c;
      --avail-green:    #15803d;
      --avail-bg:       #dcfce7;
      --busy-red:       #dc2626;
      --busy-bg:        #fee2e2;
      /* TMNT colors */
      --leo:   #1a4a9c;
      --don:   #7b3fa0;
      --raph:  #c0392b;
      --mikey: #e07b00;
    }
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:'Roboto',sans-serif; background:var(--off-white); color:var(--text); min-height:100vh; }

    /* ── LOGIN ── */
    #login-overlay { position:fixed; inset:0; z-index:1000; background:var(--uvm-green-dark); display:flex; align-items:center; justify-content:center; transition:opacity .35s ease; }
    #login-overlay.hidden { opacity:0; pointer-events:none; }
    .login-card { background:var(--white); width:440px; max-width:95vw; border-top:6px solid var(--uvm-gold); border-radius:2px; padding:48px 44px 44px; box-shadow:0 20px 60px rgba(0,0,0,.35); animation:rise .4s cubic-bezier(.22,1,.36,1); }
    @keyframes rise { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:none} }
    .login-brand { display:flex; align-items:center; gap:14px; margin-bottom:30px; padding-bottom:24px; border-bottom:1px solid var(--border); }
    .uvm-logo-box { width:44px; height:44px; background:var(--uvm-green); border-radius:2px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .uvm-logo-box span { color:var(--uvm-gold); font-family:'Lora',serif; font-size:14px; font-weight:700; }
    .login-brand-text .uni { font-size:.73rem; color:var(--muted); text-transform:uppercase; letter-spacing:.09em; }
    .login-brand-text .dept { font-size:.92rem; font-weight:700; color:var(--uvm-green); margin-top:2px; }
    .login-card h2 { font-family:'Lora',serif; font-size:1.6rem; color:var(--uvm-green); margin-bottom:6px; }
    .login-card .sub { color:var(--muted); font-size:.9rem; margin-bottom:30px; }
    .field { margin-bottom:18px; }
    .field label { display:block; font-size:.75rem; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); margin-bottom:6px; }
    .field input, .field textarea, .field select { width:100%; padding:11px 14px; border:1.5px solid var(--border); border-radius:2px; font-family:'Roboto',sans-serif; font-size:.95rem; outline:none; transition:border-color .2s; }
    .field input:focus, .field textarea:focus { border-color:var(--uvm-green); }
    .field textarea { resize:vertical; min-height:120px; font-size:.85rem; line-height:1.5; }
    #login-error { font-size:.85rem; color:var(--red); min-height:20px; margin-bottom:10px; }
    .btn-primary { width:100%; padding:13px; background:var(--uvm-green); color:var(--white); border:none; border-radius:2px; font-family:'Roboto',sans-serif; font-size:.95rem; font-weight:700; cursor:pointer; transition:background .2s; }
    .btn-primary:hover { background:var(--uvm-green-mid); }

    /* ── APP SHELL ── */
    #app { display:none; min-height:100vh; flex-direction:column; }
    #app.visible { display:flex; animation:fadeIn .3s ease; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .topbar { background:var(--uvm-green-dark); color:var(--white); padding:0 28px; height:56px; display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
    .topbar-brand { display:flex; align-items:center; gap:14px; }
    .topbar-logo { width:32px; height:32px; background:var(--uvm-gold); border-radius:2px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .topbar-logo span { color:var(--uvm-green-dark); font-family:'Lora',serif; font-size:11px; font-weight:700; }
    .topbar-brand-text { border-left:1px solid rgba(255,255,255,.2); padding-left:14px; }
    .topbar-brand-text .uni { font-size:.67rem; color:rgba(255,255,255,.6); text-transform:uppercase; letter-spacing:.08em; }
    .topbar-brand-text .dept { font-size:.85rem; font-weight:500; }
    .topbar-user { display:flex; align-items:center; gap:10px; font-size:.84rem; color:rgba(255,255,255,.85); }
    .role-chip { padding:3px 10px; border-radius:2px; font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:.06em; }
    .role-chip.admin { background:var(--uvm-gold); color:var(--uvm-green-dark); }
    .role-chip.user  { background:var(--uvm-green-mid); color:white; }
    .role-chip.read  { background:#555; color:white; }
    .gold-bar { height:5px; background:var(--uvm-gold); flex-shrink:0; }
    .app-body { display:flex; flex:1; overflow:hidden; }

    /* ── SIDEBAR ── */
    .sidebar { width:232px; flex-shrink:0; background:var(--uvm-green); color:var(--white); display:flex; flex-direction:column; overflow-y:auto; }
    .sidebar-section-label { font-size:.67rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:rgba(255,255,255,.4); padding:18px 18px 7px; }
    .nav-item { display:flex; align-items:center; gap:10px; padding:10px 18px; cursor:pointer; font-size:.87rem; font-weight:500; color:rgba(255,255,255,.75); border-left:3px solid transparent; transition:background .15s,color .15s,border-color .15s; user-select:none; }
    .nav-item:hover { background:rgba(255,255,255,.08); color:white; }
    .nav-item.active { background:rgba(255,255,255,.12); color:white; border-left-color:var(--uvm-gold); }
    .nav-item svg { width:15px; height:15px; flex-shrink:0; opacity:.7; }
    .nav-item.active svg { opacity:1; }
    .sidebar-divider { height:1px; background:rgba(255,255,255,.1); margin:6px 0; }
    .nav-sub-item { display:flex; align-items:center; gap:9px; padding:8px 18px 8px 34px; cursor:pointer; font-size:.84rem; color:rgba(255,255,255,.65); border-left:3px solid transparent; transition:background .15s,color .15s,border-color .15s; }
    .nav-sub-item:hover { background:rgba(255,255,255,.06); color:rgba(255,255,255,.9); }
    .nav-sub-item.active { color:white; border-left-color:var(--uvm-gold); }
    .printer-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

    /* Printer status mini-cards in sidebar */
    .sidebar-printer-info { padding:6px 12px 4px; }
    .sidebar-printer-card { background:rgba(255,255,255,.07); border-radius:3px; padding:8px 10px; margin-bottom:4px; cursor:pointer; transition:background .15s; border-left:3px solid transparent; }
    .sidebar-printer-card:hover { background:rgba(255,255,255,.12); }
    .sidebar-printer-card.active { background:rgba(255,255,255,.14); }
    .spc-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:4px; }
    .spc-name { font-size:.8rem; font-weight:700; color:white; }
    .spc-status { font-size:.65rem; font-weight:700; text-transform:uppercase; letter-spacing:.05em; padding:2px 6px; border-radius:10px; }
    .spc-status.free { background:rgba(21,128,61,.4); color:#86efac; }
    .spc-status.busy { background:rgba(220,38,38,.3); color:#fca5a5; }
    .spc-bar-track { height:4px; background:rgba(255,255,255,.15); border-radius:2px; overflow:hidden; }
    .spc-bar-fill { height:100%; border-radius:2px; transition:width .6s; }

    /* ── MAIN ── */
    .main-content { flex:1; overflow-y:auto; }
    .page { display:none; animation:fadeIn .2s ease; }
    .page.active { display:block; }
    .page-header { background:var(--white); border-bottom:1px solid var(--border); padding:22px 32px 18px; }
    .breadcrumb { font-size:.72rem; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; margin-bottom:7px; }
    .breadcrumb span { margin:0 5px; }
    .page-header h1 { font-family:'Lora',serif; font-size:1.7rem; color:var(--uvm-green); margin-bottom:4px; }
    .page-header p { color:var(--muted); font-size:.9rem; }
    .page-body { padding:26px 32px 60px; }

    /* ── DASHBOARD ── */
    .dash-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:26px; }
    .printer-card { background:var(--white); border:1.5px solid var(--border); border-radius:3px; padding:18px 20px; cursor:pointer; transition:border-color .2s,box-shadow .2s,transform .15s; border-top:4px solid var(--border); }
    .printer-card:hover { box-shadow:0 4px 16px rgba(0,0,0,.09); transform:translateY(-2px); }
    .card-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .card-name { font-family:'Lora',serif; font-size:.95rem; color:var(--uvm-green); }
    .status-badge { font-size:.69rem; font-weight:700; text-transform:uppercase; letter-spacing:.05em; padding:2px 8px; border-radius:20px; }
    .status-badge.free { background:var(--avail-bg); color:var(--avail-green); }
    .status-badge.busy { background:var(--busy-bg); color:var(--busy-red); }
    .fullness-label { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:5px; }
    .fl-text { font-size:.74rem; color:var(--muted); font-weight:500; text-transform:uppercase; letter-spacing:.04em; }
    .fl-pct { font-size:1rem; font-weight:700; color:var(--uvm-green); }
    .fullness-track { height:7px; background:var(--border); border-radius:4px; overflow:hidden; margin-bottom:9px; }
    .fullness-fill { height:100%; border-radius:4px; transition:width .6s cubic-bezier(.22,1,.36,1); }
    .fill-low { background:var(--avail-green); } .fill-medium { background:var(--uvm-gold); } .fill-high { background:var(--busy-red); }
    .card-next { font-size:.78rem; color:var(--muted); margin-top:3px; }
    .card-cta { margin-top:12px; font-size:.74rem; font-weight:700; color:var(--uvm-green); text-transform:uppercase; letter-spacing:.05em; }
    .info-box { background:var(--white); border:1px solid var(--border); border-left:4px solid var(--uvm-gold); border-radius:2px; padding:16px 20px; margin-bottom:24px; }
    .info-box h3 { font-family:'Lora',serif; font-size:.95rem; color:var(--uvm-green); margin-bottom:5px; }
    .info-box p { font-size:.87rem; color:var(--muted); line-height:1.6; }

    /* ── OVERVIEW PAGE ── */
    .overview-toggles { display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
    .toggle-btn { display:flex; align-items:center; gap:7px; padding:7px 14px; border-radius:2px; border:2px solid transparent; cursor:pointer; font-family:'Roboto',sans-serif; font-size:.83rem; font-weight:700; transition:opacity .2s, transform .1s; }
    .toggle-btn.off { opacity:.35; }
    .toggle-btn:hover { transform:translateY(-1px); }
    .toggle-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
    .overview-calendar-wrap { background:var(--white); border:1px solid var(--border); border-radius:3px; padding:22px; }

    /* ── SCHEDULE ── */
    .schedule-header-bar { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap; gap:10px; }
    .printer-color-tag { display:flex; align-items:center; gap:8px; font-size:.81rem; font-weight:700; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); }
    .printer-color-tag .dot { width:10px; height:10px; border-radius:50%; }
    .mini-fullness { display:flex; align-items:center; gap:10px; }
    .mini-track { width:110px; height:6px; background:var(--border); border-radius:4px; overflow:hidden; }
    .mini-fill { height:100%; border-radius:4px; transition:width .6s; }
    .mini-pct { font-size:.81rem; font-weight:700; color:var(--uvm-green); }
    .calendar-wrap { background:var(--white); border:1px solid var(--border); border-radius:3px; padding:20px; }
    .fc .fc-toolbar-title { font-family:'Lora',serif; font-size:1rem; color:var(--uvm-green); }
    .fc .fc-button-primary { background:var(--uvm-green) !important; border-color:var(--uvm-green) !important; font-family:'Roboto',sans-serif !important; border-radius:2px !important; font-size:.82rem !important; }
    .fc .fc-button-primary:hover { background:var(--uvm-green-mid) !important; }
    .fc .fc-button-primary.fc-button-active { background:var(--uvm-gold) !important; border-color:var(--uvm-gold) !important; color:var(--uvm-green-dark) !important; }
    .fc .fc-col-header-cell { background:var(--uvm-green-dark); }
    .fc .fc-col-header-cell-cushion { color:rgba(255,255,255,.85); font-size:.73rem; font-weight:700; text-transform:uppercase; letter-spacing:.06em; padding:7px 4px; }
    .fc-timegrid-slot { height:34px !important; }
    .fc .fc-event { border-radius:2px !important; font-size:.8rem !important; padding:2px 5px !important; font-weight:600 !important; cursor:pointer !important; }
    .fc .fc-timegrid-now-indicator-line { border-color:var(--uvm-gold) !important; border-width:2px !important; }
    .fc .fc-day-today { background:rgba(21,71,52,.04) !important; }
    .fc .fc-col-header-cell.fc-day-today { background:var(--uvm-green) !important; }
    .fc .fc-col-header-cell.fc-day-today .fc-col-header-cell-cushion { color:var(--uvm-gold) !important; }
    /* Per-printer calendar colors */
    #cal-0 .fc-event { background:var(--leo) !important; border-color:#0f2d60 !important; }
    #cal-1 .fc-event { background:var(--don) !important; border-color:#4a1d6a !important; }
    #cal-2 .fc-event { background:var(--raph) !important; border-color:#7b1a14 !important; }
    #cal-3 .fc-event { background:var(--mikey) !important; border-color:#a05800 !important; }

    /* ── MY BOOKINGS ── */
    .bookings-section-title { font-family:'Lora',serif; font-size:1.05rem; color:var(--uvm-green); margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid var(--uvm-gold); }
    .bookings-section { margin-bottom:36px; }
    .bookings-empty { text-align:center; padding:40px 20px; color:var(--muted); background:var(--white); border:1px solid var(--border); border-radius:3px; }
    .bookings-empty .big-icon { font-size:2rem; margin-bottom:10px; opacity:.3; }
    .booking-list { display:flex; flex-direction:column; gap:8px; }
    .booking-row { background:var(--white); border:1px solid var(--border); border-radius:3px; padding:14px 18px; display:flex; align-items:center; gap:14px; }
    .booking-row.past { opacity:.65; }
    .br-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
    .br-info { flex:1; }
    .br-printer { font-weight:700; font-size:.88rem; color:var(--uvm-green); }
    .br-time { font-size:.81rem; color:var(--muted); margin-top:2px; }
    .br-delete { background:none; border:1.5px solid var(--border); border-radius:2px; padding:4px 12px; font-size:.76rem; font-weight:700; color:var(--red); cursor:pointer; transition:background .2s,border-color .2s; font-family:'Roboto',sans-serif; }
    .br-delete:hover { background:var(--busy-bg); border-color:var(--busy-red); }

    /* ── HISTORY ── */
    .history-toolbar { display:flex; align-items:center; gap:10px; margin-bottom:18px; flex-wrap:wrap; }
    .history-toolbar select { padding:7px 11px; border:1.5px solid var(--border); border-radius:2px; font-family:'Roboto',sans-serif; font-size:.87rem; outline:none; color:var(--text); }
    .btn-action { padding:8px 16px; background:var(--uvm-green); color:white; border:none; border-radius:2px; font-family:'Roboto',sans-serif; font-size:.84rem; font-weight:700; cursor:pointer; transition:background .2s; }
    .btn-action:hover { background:var(--uvm-green-mid); }
    .btn-danger { padding:8px 16px; background:none; color:var(--red); border:1.5px solid var(--red); border-radius:2px; font-family:'Roboto',sans-serif; font-size:.84rem; font-weight:700; cursor:pointer; }
    .btn-danger:hover { background:var(--busy-bg); }
    .history-table { width:100%; border-collapse:collapse; background:var(--white); border:1px solid var(--border); border-radius:3px; overflow:hidden; font-size:.87rem; }
    .history-table th { background:var(--uvm-green-dark); color:rgba(255,255,255,.9); padding:10px 14px; text-align:left; font-size:.73rem; text-transform:uppercase; letter-spacing:.07em; font-weight:700; }
    .history-table td { padding:10px 14px; border-bottom:1px solid var(--border); }
    .history-table tr:last-child td { border-bottom:none; }
    .history-table tr:hover td { background:var(--off-white); }
    .history-tag { display:inline-block; padding:2px 7px; border-radius:10px; font-size:.69rem; font-weight:700; text-transform:uppercase; letter-spacing:.04em; }
    .history-tag.active { background:var(--avail-bg); color:var(--avail-green); }
    .history-tag.deleted { background:var(--busy-bg); color:var(--busy-red); }
    .history-empty { text-align:center; padding:40px; color:var(--muted); font-size:.9rem; background:var(--white); border:1px solid var(--border); border-radius:3px; }

    /* ── RULES PAGE ── */
    .rules-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:18px; margin-bottom:28px; }
    .printer-spec-card { background:var(--white); border:1px solid var(--border); border-radius:3px; padding:22px; border-top:4px solid var(--border); }
    .psc-header { display:flex; align-items:center; gap:10px; margin-bottom:16px; }
    .psc-dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
    .psc-name { font-family:'Lora',serif; font-size:1.05rem; color:var(--uvm-green); }
    .spec-row { display:flex; gap:10px; margin-bottom:10px; font-size:.87rem; }
    .spec-label { font-weight:700; color:var(--muted); text-transform:uppercase; font-size:.72rem; letter-spacing:.05em; width:110px; flex-shrink:0; padding-top:2px; }
    .spec-value { color:var(--text); line-height:1.5; }
    .rules-section { background:var(--white); border:1px solid var(--border); border-left:4px solid var(--uvm-gold); border-radius:2px; padding:20px 24px; margin-bottom:18px; }
    .rules-section h3 { font-family:'Lora',serif; font-size:1rem; color:var(--uvm-green); margin-bottom:10px; }
    .rules-list { list-style:none; display:flex; flex-direction:column; gap:7px; }
    .rules-list li { font-size:.88rem; color:var(--text); line-height:1.55; padding-left:16px; position:relative; }
    .rules-list li::before { content:'›'; position:absolute; left:0; color:var(--uvm-gold); font-weight:700; }
    .x1-info-box { background:var(--uvm-green-dark); color:white; border-radius:3px; padding:20px 24px; margin-bottom:18px; }
    .x1-info-box h3 { font-family:'Lora',serif; font-size:1rem; color:var(--uvm-gold); margin-bottom:8px; }
    .x1-info-box p { font-size:.87rem; color:rgba(255,255,255,.8); line-height:1.6; }

    /* ── ADMIN CSV TOOL ── */
    .admin-tool-box { background:var(--white); border:1px solid var(--border); border-radius:3px; padding:24px; margin-bottom:20px; }
    .admin-tool-box h3 { font-family:'Lora',serif; font-size:1rem; color:var(--uvm-green); margin-bottom:6px; }
    .admin-tool-box p { font-size:.87rem; color:var(--muted); margin-bottom:16px; line-height:1.55; }
    .csv-preview { background:var(--off-white); border:1px solid var(--border); border-radius:2px; padding:12px 14px; font-size:.8rem; font-family:monospace; color:var(--muted); margin-top:12px; max-height:160px; overflow-y:auto; white-space:pre; }
    .admin-actions { display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }

    /* ── MODALS ── */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:500; }
    .modal-overlay.open { display:flex; }
    .modal-box { background:var(--white); border-top:4px solid var(--uvm-gold); border-radius:2px; padding:30px 34px; max-width:440px; width:92%; box-shadow:0 20px 60px rgba(0,0,0,.25); animation:rise .3s ease; }
    .modal-box h3 { font-family:'Lora',serif; font-size:1.1rem; color:var(--uvm-green); margin-bottom:7px; }
    .modal-box p { color:var(--muted); font-size:.88rem; margin-bottom:18px; line-height:1.55; }
    .modal-box .field input { width:100%; padding:10px 13px; border:1.5px solid var(--border); border-radius:2px; font-family:'Roboto',sans-serif; font-size:.93rem; outline:none; transition:border-color .2s; }
    .modal-box .field input:focus { border-color:var(--uvm-green); }
    .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:20px; }
    .btn-cancel { padding:8px 18px; border:1.5px solid var(--border); background:none; border-radius:2px; font-family:'Roboto',sans-serif; font-size:.88rem; font-weight:600; color:var(--muted); cursor:pointer; }
    .btn-cancel:hover { border-color:var(--uvm-green); color:var(--uvm-green); }
    .btn-confirm { padding:8px 18px; background:var(--uvm-green); color:white; border:none; border-radius:2px; font-family:'Roboto',sans-serif; font-size:.88rem; font-weight:700; cursor:pointer; }
    .btn-confirm:hover { background:var(--uvm-green-mid); }
    .btn-delete { padding:8px 18px; background:var(--red); color:white; border:none; border-radius:2px; font-family:'Roboto',sans-serif; font-size:.88rem; font-weight:700; cursor:pointer; }
    .btn-delete:hover { background:#991b1b; }

    /* ── TOAST ── */
    #toast { position:fixed; bottom:22px; left:50%; transform:translateX(-50%) translateY(60px); background:var(--uvm-green-dark); color:white; padding:9px 20px; border-radius:2px; font-size:.86rem; font-weight:500; border-left:4px solid var(--uvm-gold); box-shadow:0 8px 28px rgba(0,0,0,.25); transition:transform .3s cubic-bezier(.22,1,.36,1),opacity .3s; opacity:0; z-index:999; pointer-events:none; white-space:nowrap; }
    #toast.show { transform:translateX(-50%) translateY(0); opacity:1; }

    @media(max-width:1100px) { .dash-grid{grid-template-columns:repeat(2,1fr);} .rules-grid{grid-template-columns:1fr;} }
    @media(max-width:700px) { .dash-grid{grid-template-columns:1fr;} .app-body{flex-direction:column;} .sidebar{width:100%;} .page-body{padding:16px 14px 50px;} .page-header{padding:16px 14px 14px;} }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-overlay">
  <div class="login-card">
    <div class="login-brand">
      <div class="uvm-logo-box"><span>UVM</span></div>
      <div class="login-brand-text">
        <div class="uni">University of Vermont</div>
        <div class="dept">FabLab — 3D Printer Scheduler</div>
      </div>
    </div>
    <h2>Sign In</h2>
    <p class="sub">Enter your name and PIN to continue.</p>
    <div class="field"><label>Name</label><input type="text" id="login-name" placeholder="Your full name" autocomplete="off"/></div>
    <div class="field"><label>PIN</label><input type="password" id="login-pin" placeholder="••••" maxlength="8"/></div>
    <div id="login-error"></div>
    <button class="btn-primary" id="login-btn">Sign In</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-brand">
      <div class="topbar-logo"><span>UVM</span></div>
      <div class="topbar-brand-text">
        <div class="uni">University of Vermont</div>
        <div class="dept">FabLab — 3D Printer Scheduler</div>
      </div>
    </div>
    <div class="topbar-user">
      <span id="user-name-display">—</span>
      <span class="role-chip" id="user-role-display">—</span>
    </div>
  </div>
  <div class="gold-bar"></div>

  <div class="app-body">
    <nav class="sidebar">
      <div class="sidebar-section-label">Navigation</div>
      <div class="nav-item active" data-page="dashboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Dashboard
      </div>
      <div class="nav-item" data-page="overview">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        All Printers
      </div>
      <div class="sidebar-divider"></div>
      <div class="sidebar-section-label">Printers</div>
      <!-- Printer info cards injected here by JS -->
      <div id="sidebar-printer-cards"></div>
      <div class="sidebar-divider"></div>
      <div class="nav-item" data-page="my-bookings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/></svg>
        My Bookings
      </div>
      <div class="nav-item" data-page="rules">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Rules &amp; Info
      </div>
      <div class="nav-item" id="nav-history" data-page="history" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        History
      </div>
      <div class="nav-item" id="nav-admin" data-page="admin" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        Admin
      </div>
    </nav>

    <div class="main-content">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <div class="page-header">
          <div class="breadcrumb">FabLab <span>›</span> Dashboard</div>
          <h1>Dashboard</h1>
          <p>Live availability and weekly capacity for all four printers.</p>
        </div>
        <div class="page-body">
          <div class="info-box">
            <h3>How to book</h3>
            <p>Select a printer from the sidebar or click a card below. On the schedule page, click or drag an open time slot, enter your print duration, and your reservation is saved automatically.</p>
          </div>
          <div class="dash-grid" id="dash-grid"></div>
        </div>
      </div>

      <!-- OVERVIEW (all 4 printers overlaid) -->
      <div class="page" id="page-overview">
        <div class="page-header">
          <div class="breadcrumb">FabLab <span>›</span> All Printers</div>
          <h1>All Printers — Overview</h1>
          <p>Read-only view of all four printers. Toggle printers on/off. Book from individual printer pages.</p>
        </div>
        <div class="page-body">
          <div class="overview-toggles" id="overview-toggles"></div>
          <div class="overview-calendar-wrap"><div id="cal-overview"></div></div>
        </div>
      </div>

      <!-- SCHEDULE PAGES (4 printers) -->
      <div class="page" id="page-schedule-0">
        <div class="page-header">
          <div class="breadcrumb">FabLab <span>›</span> Printers <span>›</span> Leonardo</div>
          <h1>Leonardo</h1>
          <p>Click or drag an open slot to book. Click your reservation to delete it.</p>
        </div>
        <div class="page-body">
          <div class="schedule-header-bar">
            <div class="printer-color-tag"><div class="dot" style="background:var(--leo)"></div>Leonardo — This Week</div>
            <div class="mini-fullness"><div class="mini-track"><div class="mini-fill fill-low" id="mini-fill-0" style="width:0%"></div></div><span class="mini-pct" id="mini-pct-0">0% full</span></div>
          </div>
          <div class="calendar-wrap"><div id="cal-0"></div></div>
        </div>
      </div>

      <div class="page" id="page-schedule-1">
        <div class="page-header">
          <div class="breadcrumb">FabLab <span>›</span> Printers <span>›</span> Donatello</div>
          <h1>Donatello</h1>
          <p>Click or drag an open slot to book. Click your reservation to delete it.</p>
        </div>
        <div class="page-body">
          <div class="schedule-header-bar">
            <div class="printer-color-tag"><div class="dot" style="background:var(--don)"></div>Donatello — This Week</div>
            <div class="mini-fullness"><div class="mini-track"><div class="mini-fill fill-low" id="mini-fill-1" style="width:0%"></div></div><span class="mini-pct" id="mini-pct-1">0% full</span></div>
          </div>
          <div class="calendar-wrap"><div id="cal-1"></div></div>
        </div>
      </div>

      <div class="page" id="page-schedule-2">
        <div class="page-header">
          <div class="breadcrumb">FabLab <span>›</span> Printers <span>›</span> Raphael</div>
          <h1>Raphael</h1>
          <p>Click or drag an open slot to book. Click your reservation to delete it.</p>
        </div>
        <div class="page-body">
          <div class="schedule-header-bar">
            <div class="printer-color-tag"><div class="dot" style="background:var(--raph)"></div>Raphael — This Week</div>
            <div class="mini-fullness"><div class="mini-track"><div class="mini-fill fill-low" id="mini-fill-2" style="width:0%"></div></div><span class="mini-pct" id="mini-pct-2">0% full</span></div>
          </div>
          <div class="calendar-wrap"><div id="cal-2"></div></div>
        </div>
      </div>

      <div class="page" id="page-schedule-3">
        <div class="page-header">
          <div class="breadcrumb">FabLab <span>›</span> Printers <span>›</span> Michelangelo</div>
          <h1>Michelangelo</h1>
          <p>Click or drag an open slot to book. Click your reservation to delete it.</p>
        </div>
        <div class="page-body">
          <div class="schedule-header-bar">
            <div class="printer-color-tag"><div class="dot" style="background:var(--mikey)"></div>Michelangelo — This Week</div>
            <div class="mini-fullness"><div class="mini-track"><div class="mini-fill fill-low" id="mini-fill-3" style="width:0%"></div></div><span class="mini-pct" id="mini-pct-3">0% full</span></div>
          </div>
          <div class="calendar-wrap"><div id="cal-3"></div></div>
        </div>
      </div>

      <!-- MY BOOKINGS -->
      <div class="page" id="page-my-bookings">
        <div class="page-header">
          <div class="breadcrumb">FabLab <span>›</span> My Bookings</div>
          <h1>My Bookings</h1>
          <p>All your reservations — upcoming and past.</p>
        </div>
        <div class="page-body">
          <div class="bookings-section" id="bookings-upcoming">
            <div class="bookings-section-title">Upcoming</div>
            <div id="bookings-upcoming-list"></div>
          </div>
          <div class="bookings-section" id="bookings-past">
            <div class="bookings-section-title">Past</div>
            <div id="bookings-past-list"></div>
          </div>
        </div>
      </div>

      <!-- RULES & INFO -->
      <div class="page" id="page-rules">
        <div class="page-header">
          <div class="breadcrumb">FabLab <span>›</span> Rules &amp; Info</div>
          <h1>Rules &amp; Printer Info</h1>
          <p>Guidelines for using the FabLab and technical specifications for each printer.</p>
        </div>
        <div class="page-body">
          <div class="x1-info-box">
            <h3>About the Bambu Lab X1 Carbon</h3>
            <p>The X1 Carbon is Bambu Lab's flagship multi-material FDM 3D printer, featuring a CoreXY motion system with a high-speed 20,000 mm/s² acceleration. It includes a built-in AI inspection camera, lidar-based first layer scanning, and an Automatic Material System (AMS) for multi-color printing. All four FabLab printers are X1 Carbon units.</p>
          </div>
          <div class="rules-grid" id="printer-spec-cards"></div>
          <div class="rules-section">
            <h3>Booking Rules</h3>
            <ul class="rules-list">
              <li>Reservations must be made in advance via this scheduler.</li>
              <li>Maximum booking duration is 8 hours per session.</li>
              <li>Cancel your booking if your plans change so others can use the printer.</li>
              <li>You are responsible for your print — stay nearby or check in regularly.</li>
              <li>Only use approved materials (PLA, Support for PLA, PLA-CF).</li>
              <li>Do not load or unload filament without proper training.</li>
            </ul>
          </div>
          <div class="rules-section">
            <h3>After Your Print</h3>
            <ul class="rules-list">
              <li>Remove your print promptly at the end of your booking window.</li>
              <li>Clean the build plate using the provided tools.</li>
              <li>Report any issues or failed prints to FabLab staff.</li>
              <li>Do not leave filament loaded in the printer after your session.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- HISTORY -->
      <div class="page" id="page-history">
        <div class="page-header">
          <div class="breadcrumb">FabLab <span>›</span> History</div>
          <h1>Booking History</h1>
          <p>All active and past reservations across all printers. Admin view only.</p>
        </div>
        <div class="page-body">
          <div class="history-toolbar">
            <select id="history-filter-printer">
              <option value="all">All Printers</option>
              <option value="0">Leonardo</option>
              <option value="1">Donatello</option>
              <option value="2">Raphael</option>
              <option value="3">Michelangelo</option>
            </select>
            <select id="history-filter-status">
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="deleted">Deleted</option>
            </select>
            <button class="btn-action" id="btn-export-csv">⬇ Export Week CSV</button>
            <button class="btn-danger" id="btn-clear-history">Clear History</button>
          </div>
          <div id="history-container"></div>
        </div>
      </div>

      <!-- ADMIN -->
      <div class="page" id="page-admin">
        <div class="page-header">
          <div class="breadcrumb">FabLab <span>›</span> Admin</div>
          <h1>Admin Panel</h1>
          <p>Manage users and system settings.</p>
        </div>
        <div class="page-body">
          <div class="admin-tool-box">
            <h3>Update Users CSV</h3>
            <p>Paste the full contents of your updated users.csv below. This will overwrite the current user list immediately. Format: <code>name,pin,role</code> (one user per line, roles: admin / user / read).</p>
            <div class="field"><label>CSV Content</label><textarea id="admin-csv-input" placeholder="name,pin,role&#10;Alex Johnson,1234,admin&#10;Jordan Smith,5678,user"></textarea></div>
            <div id="admin-csv-preview" class="csv-preview" style="display:none"></div>
            <div class="admin-actions">
              <button class="btn-action" id="btn-preview-csv">Preview</button>
              <button class="btn-action" id="btn-save-csv" style="display:none">Save &amp; Apply</button>
              <button class="btn-danger" id="btn-clear-bookings">Clear All Bookings</button>
            </div>
          </div>
          <div class="admin-tool-box">
            <h3>Current Users</h3>
            <p>Users currently loaded from localStorage. If empty, users.csv on the server is used at login.</p>
            <div id="admin-current-users" class="csv-preview"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="duration-modal">
  <div class="modal-box">
    <h3>New Reservation</h3>
    <p id="duration-info"></p>
    <div class="field"><label>Duration (minutes)</label><input type="number" id="duration-input" min="1" max="600" placeholder="e.g. 90"/></div>
    <div class="modal-actions">
      <button class="btn-cancel" id="duration-cancel">Cancel</button>
      <button class="btn-confirm" id="duration-confirm">Book Slot</button>
    </div>
  </div>
</div>
<div class="modal-overlay" id="choice-modal">
  <div class="modal-box">
    <h3 id="choice-title">Confirm</h3>
    <p id="choice-message"></p>
    <div class="modal-actions">
      <button class="btn-cancel" id="choice-cancel">Cancel</button>
      <button class="btn-confirm" id="choice-confirm">OK</button>
    </div>
  </div>
</div>
<div class="modal-overlay" id="delete-modal">
  <div class="modal-box">
    <h3>Delete Reservation</h3>
    <p id="delete-message"></p>
    <div class="modal-actions">
      <button class="btn-cancel" id="delete-cancel">Keep It</button>
      <button class="btn-delete" id="delete-confirm">Delete</button>
    </div>
  </div>
</div>
<div id="toast"></div>

<script>
// ── UTILITIES ──
function toast(msg,ms=2800){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),ms);}
function showModal(id){document.getElementById(id).classList.add('open');}
function hideModal(id){document.getElementById(id).classList.remove('open');}
function choiceModal({title='Confirm',message,confirmText='OK',cancelText='Cancel',danger=false}){
  return new Promise(resolve=>{
    document.getElementById('choice-title').textContent=title;
    document.getElementById('choice-message').textContent=message;
    const ok=document.getElementById('choice-confirm'),no=document.getElementById('choice-cancel');
    ok.textContent=confirmText;no.textContent=cancelText;ok.className=danger?'btn-delete':'btn-confirm';
    showModal('choice-modal');
    const yes=()=>{cleanup();resolve(true);},nop=()=>{cleanup();resolve(false);};
    function cleanup(){hideModal('choice-modal');ok.removeEventListener('click',yes);no.removeEventListener('click',nop);}
    ok.addEventListener('click',yes);no.addEventListener('click',nop);
  });
}
function deleteModal(label){
  return new Promise(resolve=>{
    document.getElementById('delete-message').textContent=`Are you sure you want to delete "${label}"?`;
    showModal('delete-modal');
    const yes=()=>{cleanup();resolve(true);},no=()=>{cleanup();resolve(false);};
    function cleanup(){hideModal('delete-modal');document.getElementById('delete-confirm').removeEventListener('click',yes);document.getElementById('delete-cancel').removeEventListener('click',no);}
    document.getElementById('delete-confirm').addEventListener('click',yes);
    document.getElementById('delete-cancel').addEventListener('click',no);
  });
}
function durationModal(printerName,timeStr){
  return new Promise(resolve=>{
    document.getElementById('duration-info').textContent=`Booking on ${printerName} at ${timeStr}. How many minutes will your print take?`;
    document.getElementById('duration-input').value='';
    showModal('duration-modal');
    const ok=document.getElementById('duration-confirm'),no=document.getElementById('duration-cancel');
    const go=()=>{const v=parseInt(document.getElementById('duration-input').value,10);if(!v||v<=0){toast('Please enter a valid number of minutes.');return;}cleanup();resolve(v);};
    const cancel=()=>{cleanup();resolve(null);};
    const key=e=>{if(e.key==='Enter')go();};
    function cleanup(){hideModal('duration-modal');ok.removeEventListener('click',go);no.removeEventListener('click',cancel);document.getElementById('duration-input').removeEventListener('keydown',key);}
    ok.addEventListener('click',go);no.addEventListener('click',cancel);
    document.getElementById('duration-input').addEventListener('keydown',key);
    setTimeout(()=>document.getElementById('duration-input').focus(),80);
  });
}

// ── STATE ──
let currentUser=null;
const PRINTER_NAMES=['Leonardo','Donatello','Raphael','Michelangelo'];
const PRINTER_COLORS=['#1a4a9c','#7b3fa0','#c0392b','#e07b00'];
const PRINTER_COLORS_ALPHA=['rgba(26,74,156,0.5)','rgba(123,63,160,0.5)','rgba(192,57,43,0.5)','rgba(224,123,0,0.5)'];
const calendars=[];
let overviewCal=null;
const overviewToggles=[true,true,true,true];

// ── LOCAL STORAGE ──
function saveBookings(){
  const data=calendars.map(cal=>cal.getEvents().filter(e=>e.extendedProps.type==='reservation').map(e=>({title:e.title,start:e.start.toISOString(),end:e.end?e.end.toISOString():null,owner:e.extendedProps.owner})));
  localStorage.setItem('fablab_bookings',JSON.stringify(data));
}
function loadBookings(){
  try{
    const data=JSON.parse(localStorage.getItem('fablab_bookings')||'[]');
    data.forEach((printerEvents,i)=>{
      if(!calendars[i])return;
      printerEvents.forEach(ev=>calendars[i].addEvent({title:ev.title,start:ev.start,end:ev.end,extendedProps:{type:'reservation',owner:ev.owner}}));
    });
  }catch(e){console.warn('Could not load bookings',e);}
}
function getHistory(){try{return JSON.parse(localStorage.getItem('fablab_history')||'[]');}catch(e){return[];}}
function addToHistory(entry){const h=getHistory();h.unshift(entry);localStorage.setItem('fablab_history',JSON.stringify(h));}
function getStoredUsers(){try{return JSON.parse(localStorage.getItem('fablab_users')||'null');}catch(e){return null;}}
function saveUsers(csv){localStorage.setItem('fablab_users',JSON.stringify(csv));}

// ── CSV EXPORT ──
function exportWeekCSV(){
  const{monday,friday}=getWeekBounds();
  const rows=[['Printer','User','Start','End','Duration (min)']];
  calendars.forEach((cal,i)=>{
    cal.getEvents().filter(e=>e.extendedProps.type==='reservation').filter(e=>{const s=e.start,end=e.end||new Date(s.getTime()+30*60000);return end>=monday&&s<=friday;}).sort((a,b)=>a.start-b.start).forEach(e=>{
      const end=e.end||new Date(e.start.getTime()+30*60000);
      rows.push([PRINTER_NAMES[i],e.extendedProps.owner,e.start.toLocaleString(),end.toLocaleString(),Math.round((end-e.start)/60000)]);
    });
  });
  const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const weekStr=monday.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  a.href=url;a.download=`fablab-week-${weekStr.replace(/\s/g,'-')}.csv`;a.click();URL.revokeObjectURL(url);
  toast('Week exported as CSV!');
}

// ── LOGIN ──
document.getElementById('login-btn').addEventListener('click',doLogin);
document.getElementById('login-pin').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

function doLogin(){
  const name=document.getElementById('login-name').value.trim();
  const pin=document.getElementById('login-pin').value.trim();
  const errEl=document.getElementById('login-error');
  errEl.textContent='';
  if(!name||!pin){errEl.textContent='Please enter your name and PIN.';return;}

  // Check localStorage users first, then fall back to users.csv
  const storedUsers=getStoredUsers();
  if(storedUsers){
    const lines=storedUsers.trim().split('\n').slice(1);
    const user=lines.map(l=>l.split(',')).find(p=>p[0]&&p[0].trim().toLowerCase()===name.toLowerCase()&&p[1]&&p[1].trim()===pin.trim());
    if(!user){errEl.textContent='Name or PIN not found. Try again.';return;}
    currentUser={name:user[0].trim(),role:(user[2]||'read').trim().toLowerCase()};
    launchApp();return;
  }

  Papa.parse('users.csv',{
    download:true,header:true,
    complete:results=>{
      const user=results.data.find(u=>u.name&&u.name.toLowerCase().trim()===name.toLowerCase()&&String(u.pin).trim()===String(pin).trim());
      if(!user){errEl.textContent='Name or PIN not found. Try again.';return;}
      currentUser={name:user.name,role:(user.role||'read').toLowerCase().trim()};
      launchApp();
    },
    error:()=>{currentUser={name,role:'read'};errEl.textContent='Could not load users.csv — signed in as read-only.';setTimeout(launchApp,1000);}
  });
}

function launchApp(){
  const ov=document.getElementById('login-overlay');
  ov.classList.add('hidden');setTimeout(()=>ov.style.display='none',400);
  document.getElementById('app').classList.add('visible');
  document.getElementById('user-name-display').textContent=currentUser.name;
  const chip=document.getElementById('user-role-display');
  chip.textContent=currentUser.role;chip.className='role-chip '+currentUser.role;
  if(currentUser.role==='admin'){
    document.getElementById('nav-history').style.display='flex';
    document.getElementById('nav-admin').style.display='flex';
  }
  buildDashCards();
  buildSidebarPrinterCards();
  buildPrinterSpecCards();
  initCalendars();
  initOverviewCalendar();
  initNav();
  initAdminPanel();
  document.getElementById('btn-export-csv').addEventListener('click',exportWeekCSV);
  document.getElementById('btn-clear-history').addEventListener('click',async()=>{
    const ok=await choiceModal({title:'Clear History',message:'Permanently delete all booking history?',confirmText:'Clear',danger:true});
    if(ok){localStorage.removeItem('fablab_history');renderHistory();toast('History cleared.');}
  });
  document.getElementById('history-filter-printer').addEventListener('change',renderHistory);
  document.getElementById('history-filter-status').addEventListener('change',renderHistory);
}

// ── NAVIGATION ──
function initNav(){document.querySelectorAll('[data-page]').forEach(el=>el.addEventListener('click',()=>navigateTo(el.dataset.page)));}

function navigateTo(pageId){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+pageId).classList.add('active');
  document.querySelectorAll('.nav-item,.nav-sub-item').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll(`.sidebar-printer-card`).forEach(el=>el.classList.remove('active'));
  const activeEl=document.querySelector(`[data-page="${pageId}"]`);
  if(activeEl)activeEl.classList.add('active');
  if(pageId.startsWith('schedule-')){const idx=parseInt(pageId.split('-')[1]);if(calendars[idx])setTimeout(()=>calendars[idx].updateSize(),60);}
  if(pageId==='overview')setTimeout(()=>{if(overviewCal)overviewCal.updateSize();refreshOverview();},80);
  if(pageId==='my-bookings')renderMyBookings();
  if(pageId==='history')renderHistory();
  if(pageId==='admin')renderAdminUsers();
  updateAllStats();
}

// ── FULLNESS ──
const AVAIL_MINS=10*60*5;
function getWeekBounds(){
  const now=new Date(),day=now.getDay();
  const monday=new Date(now);monday.setDate(now.getDate()-(day===0?6:day-1));monday.setHours(0,0,0,0);
  const friday=new Date(monday);friday.setDate(monday.getDate()+4);friday.setHours(23,59,59,999);
  return{monday,friday};
}
function calcFullness(calIdx){
  if(!calendars[calIdx])return 0;
  const{monday,friday}=getWeekBounds();let bookedMins=0;
  calendars[calIdx].getEvents().filter(e=>e.extendedProps.type==='reservation').forEach(ev=>{
    const s=ev.start,e=ev.end||new Date(ev.start.getTime()+30*60000);
    if(e<monday||s>friday)return;
    bookedMins+=(Math.min(e,friday)-Math.max(s,monday))/60000;
  });
  return Math.min(100,Math.round((bookedMins/AVAIL_MINS)*100));
}
function fillClass(pct){return pct<50?'fill-low':pct<80?'fill-medium':'fill-high';}

function updateAllStats(){
  const now=new Date();
  PRINTER_NAMES.forEach((_,i)=>{
    const pct=calcFullness(i),fc=fillClass(pct);
    const df=document.getElementById(`dash-fill-${i}`),dp=document.getElementById(`dash-pct-${i}`);
    if(df){df.style.width=pct+'%';df.className='fullness-fill '+fc;}
    if(dp)dp.textContent=pct+'%';
    const events=calendars[i]?calendars[i].getEvents().filter(e=>e.extendedProps.type==='reservation'):[];
    const busyNow=events.find(e=>e.start<=now&&(e.end||new Date(e.start.getTime()+30*60000))>now);
    const badge=document.getElementById(`dash-badge-${i}`),nextEl=document.getElementById(`dash-next-${i}`);
    if(badge){badge.textContent=busyNow?'In Use':'Available';badge.className='status-badge '+(busyNow?'busy':'free');}
    if(nextEl){
      if(busyNow){const freeAt=busyNow.end||new Date(busyNow.start.getTime()+30*60000);nextEl.textContent=`Free at ${freeAt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`;}
      else{const upcoming=events.filter(e=>e.start>now).sort((a,b)=>a.start-b.start)[0];nextEl.textContent=upcoming?`Next: ${upcoming.start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`:'No bookings today';}
    }
    const mf=document.getElementById(`mini-fill-${i}`),mp=document.getElementById(`mini-pct-${i}`);
    if(mf){mf.style.width=pct+'%';mf.className='mini-fill '+fc;}
    if(mp)mp.textContent=pct+'% full this week';
    // Update sidebar cards
    const spcStatus=document.getElementById(`spc-status-${i}`),spcBar=document.getElementById(`spc-bar-${i}`);
    if(spcStatus){spcStatus.textContent=busyNow?'In Use':'Free';spcStatus.className='spc-status '+(busyNow?'busy':'free');}
    if(spcBar){spcBar.style.width=pct+'%';spcBar.style.background=PRINTER_COLORS[i];}
  });
}

// ── DASHBOARD CARDS ──
function buildDashCards(){
  const grid=document.getElementById('dash-grid');
  PRINTER_NAMES.forEach((name,i)=>{
    const card=document.createElement('div');card.className='printer-card';
    card.style.borderTopColor=PRINTER_COLORS[i];
    card.innerHTML=`<div class="card-top"><div class="card-name">${name}</div><div class="status-badge free" id="dash-badge-${i}">Available</div></div><div class="fullness-label"><span class="fl-text">Weekly capacity</span><span class="fl-pct" id="dash-pct-${i}">0%</span></div><div class="fullness-track"><div class="fullness-fill fill-low" id="dash-fill-${i}" style="width:0%"></div></div><div class="card-next" id="dash-next-${i}">—</div><div class="card-cta">View schedule →</div>`;
    card.addEventListener('click',()=>navigateTo('schedule-'+i));grid.appendChild(card);
  });
}

// ── SIDEBAR PRINTER CARDS ──
function buildSidebarPrinterCards(){
  const container=document.getElementById('sidebar-printer-cards');
  // Nav sub-items first
  PRINTER_NAMES.forEach((name,i)=>{
    const item=document.createElement('div');item.className='nav-sub-item';item.dataset.page=`schedule-${i}`;
    item.innerHTML=`<span class="printer-dot" style="background:${PRINTER_COLORS[i]}"></span>${name}`;
    item.addEventListener('click',()=>navigateTo(`schedule-${i}`));
    container.appendChild(item);
  });
  // Mini status cards
  const infoDiv=document.createElement('div');infoDiv.className='sidebar-printer-info';
  PRINTER_NAMES.forEach((name,i)=>{
    const card=document.createElement('div');card.className='sidebar-printer-card';
    card.dataset.page=`schedule-${i}`;
    card.innerHTML=`<div class="spc-top"><div class="spc-name">${name}</div><div class="spc-status free" id="spc-status-${i}">Free</div></div><div class="spc-bar-track"><div class="spc-bar-fill" id="spc-bar-${i}" style="width:0%;background:${PRINTER_COLORS[i]}"></div></div>`;
    card.addEventListener('click',()=>navigateTo(`schedule-${i}`));
    infoDiv.appendChild(card);
  });
  container.appendChild(infoDiv);
}

// ── PRINTER SPEC CARDS ──
function buildPrinterSpecCards(){
  const grid=document.getElementById('printer-spec-cards');
  PRINTER_NAMES.forEach((name,i)=>{
    const card=document.createElement('div');card.className='printer-spec-card';
    card.style.borderTopColor=PRINTER_COLORS[i];
    card.innerHTML=`
      <div class="psc-header"><div class="psc-dot" style="background:${PRINTER_COLORS[i]}"></div><div class="psc-name">${name}</div></div>
      <div class="spec-row"><div class="spec-label">Model</div><div class="spec-value">Bambu Lab X1 Carbon</div></div>
      <div class="spec-row"><div class="spec-label">Build Volume</div><div class="spec-value">10.07″ × 10.07″ × 10.07″ (256 × 256 × 256 mm)</div></div>
      <div class="spec-row"><div class="spec-label">Materials</div><div class="spec-value">PLA, Support for PLA, PLA-CF</div></div>
      <div class="spec-row"><div class="spec-label">Nozzle</div><div class="spec-value">0.4 mm hardened steel</div></div>
      <div class="spec-row"><div class="spec-label">Plate Type</div><div class="spec-value">Bambu Cool Plate (installed)</div></div>
      <div class="spec-row"><div class="spec-label">Max Speed</div><div class="spec-value">500 mm/s</div></div>
    `;
    grid.appendChild(card);
  });
}

// ── MY BOOKINGS ──
function renderMyBookings(){
  const now=new Date();
  let upcoming=[],past=[];
  calendars.forEach((cal,i)=>{
    cal.getEvents().filter(e=>e.extendedProps.type==='reservation'&&e.extendedProps.owner===currentUser.name).forEach(e=>{
      if(e.start>=now)upcoming.push({event:e,printerIdx:i});
      else past.push({event:e,printerIdx:i});
    });
  });
  upcoming.sort((a,b)=>a.event.start-b.event.start);
  past.sort((a,b)=>b.event.start-a.event.start);

  renderBookingList('bookings-upcoming-list',upcoming,false);
  renderBookingList('bookings-past-list',past,true);
}

function renderBookingList(containerId,bookings,isPast){
  const container=document.getElementById(containerId);
  if(!bookings.length){container.innerHTML='<div class="bookings-empty"><div class="big-icon">📋</div><p>'+(isPast?'No past bookings.':'No upcoming bookings. Head to a printer page to book a slot.')+'</p></div>';return;}
  const list=document.createElement('div');list.className='booking-list';
  bookings.forEach(({event:ev,printerIdx:pi})=>{
    const row=document.createElement('div');row.className='booking-row'+(isPast?' past':'');
    const start=ev.start.toLocaleString([],{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
    const end=ev.end?ev.end.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'—';
    const mins=ev.end?Math.round((ev.end-ev.start)/60000):'?';
    row.innerHTML=`<div class="br-dot" style="background:${PRINTER_COLORS[pi]}"></div><div class="br-info"><div class="br-printer">${PRINTER_NAMES[pi]}</div><div class="br-time">${start} – ${end} (${mins} min)</div></div>${isPast?'':'<button class="br-delete">Delete</button>'}`;
    if(!isPast){
      row.querySelector('.br-delete').addEventListener('click',async()=>{
        const confirmed=await deleteModal(`your reservation on ${PRINTER_NAMES[pi]}`);
        if(confirmed){addToHistory({printer:PRINTER_NAMES[pi],owner:ev.extendedProps.owner,start:ev.start.toISOString(),end:ev.end?ev.end.toISOString():null,status:'deleted',deletedAt:new Date().toISOString()});ev.remove();saveBookings();updateAllStats();renderMyBookings();toast('Reservation deleted.');}
      });
    }
    list.appendChild(row);
  });
  container.innerHTML='';container.appendChild(list);
}

// ── HISTORY ──
function renderHistory(){
  const container=document.getElementById('history-container');
  const filterPrinter=document.getElementById('history-filter-printer').value;
  const filterStatus=document.getElementById('history-filter-status').value;

  // Build combined list: active bookings + history entries
  let rows=[];
  // Active bookings from calendars
  calendars.forEach((cal,i)=>{
    cal.getEvents().filter(e=>e.extendedProps.type==='reservation').forEach(ev=>{
      rows.push({printer:PRINTER_NAMES[i],printerIdx:i,owner:ev.extendedProps.owner,start:ev.start.toISOString(),end:ev.end?ev.end.toISOString():null,status:'active'});
    });
  });
  // Deleted entries from history
  getHistory().forEach(h=>rows.push({...h,status:h.status||'deleted'}));

  // Filter
  if(filterPrinter!=='all')rows=rows.filter(r=>r.printer===PRINTER_NAMES[parseInt(filterPrinter)]);
  if(filterStatus!=='all')rows=rows.filter(r=>r.status===filterStatus);
  rows.sort((a,b)=>new Date(b.start)-new Date(a.start));

  if(!rows.length){container.innerHTML='<div class="history-empty">No records found.</div>';return;}
  const table=document.createElement('table');table.className='history-table';
  table.innerHTML=`<thead><tr><th>Printer</th><th>User</th><th>Date &amp; Start</th><th>End</th><th>Duration</th><th>Status</th></tr></thead>`;
  const tbody=document.createElement('tbody');
  rows.forEach(h=>{
    const start=new Date(h.start),end=h.end?new Date(h.end):null;
    const mins=end?Math.round((end-start)/60000):'?';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><span style="display:inline-flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:${PRINTER_COLORS[PRINTER_NAMES.indexOf(h.printer)]};flex-shrink:0"></span>${h.printer}</span></td><td>${h.owner}</td><td>${start.toLocaleString([],{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</td><td>${end?end.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'—'}</td><td>${mins} min</td><td><span class="history-tag ${h.status}">${h.status}</span></td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);container.innerHTML='';container.appendChild(table);
}

// ── ADMIN PANEL ──
function initAdminPanel(){
  const previewBtn=document.getElementById('btn-preview-csv');
  const saveBtn=document.getElementById('btn-save-csv');
  const clearBtn=document.getElementById('btn-clear-bookings');
  previewBtn.addEventListener('click',()=>{
    const csv=document.getElementById('admin-csv-input').value.trim();
    if(!csv){toast('Paste CSV content first.');return;}
    const preview=document.getElementById('admin-csv-preview');
    preview.textContent=csv;preview.style.display='block';
    saveBtn.style.display='inline-block';
  });
  saveBtn.addEventListener('click',async()=>{
    const csv=document.getElementById('admin-csv-input').value.trim();
    const ok=await choiceModal({title:'Save Users',message:'This will overwrite the current user list. Continue?',confirmText:'Save'});
    if(ok){saveUsers(csv);renderAdminUsers();toast('Users updated! Takes effect on next login.');saveBtn.style.display='none';}
  });
  clearBtn.addEventListener('click',async()=>{
    const ok=await choiceModal({title:'Clear All Bookings',message:'This will permanently delete ALL bookings from all printers. This cannot be undone.',confirmText:'Clear Everything',danger:true});
    if(ok){
      calendars.forEach(cal=>cal.getEvents().filter(e=>e.extendedProps.type==='reservation').forEach(e=>e.remove()));
      saveBookings();updateAllStats();refreshOverview();toast('All bookings cleared.');
    }
  });
}

function renderAdminUsers(){
  const storedUsers=getStoredUsers();
  const el=document.getElementById('admin-current-users');
  el.textContent=storedUsers||'(using users.csv from server)';
}

// ── OVERVIEW CALENDAR ──
function initOverviewCalendar(){
  const el=document.getElementById('cal-overview');
  overviewCal=new FullCalendar.Calendar(el,{
    initialView:'timeGridWeek',selectable:false,editable:false,
    height:'auto',allDaySlot:false,slotMinTime:'08:00:00',slotMaxTime:'18:00:00',
    hiddenDays:[0,6],nowIndicator:true,
    headerToolbar:{left:'prev,next today',center:'title',right:'timeGridWeek,timeGridDay'},
    events:[],
    eventClick:function(info){
      const pi=info.event.extendedProps.printerIdx;
      toast(`${info.event.extendedProps.owner} — ${PRINTER_NAMES[pi]}`);
    }
  });
  overviewCal.render();
  buildOverviewToggles();
}

function buildOverviewToggles(){
  const container=document.getElementById('overview-toggles');
  PRINTER_NAMES.forEach((name,i)=>{
    const btn=document.createElement('button');btn.className='toggle-btn';btn.id=`toggle-${i}`;
    btn.style.background=PRINTER_COLORS_ALPHA[i];btn.style.borderColor=PRINTER_COLORS[i];btn.style.color=PRINTER_COLORS[i];
    btn.innerHTML=`<span class="toggle-dot" style="background:${PRINTER_COLORS[i]}"></span>${name}`;
    btn.addEventListener('click',()=>{
      overviewToggles[i]=!overviewToggles[i];
      btn.classList.toggle('off',!overviewToggles[i]);
      refreshOverview();
    });
    container.appendChild(btn);
  });
}

function refreshOverview(){
  if(!overviewCal)return;
  overviewCal.getEvents().forEach(e=>e.remove());
  calendars.forEach((cal,i)=>{
    if(!overviewToggles[i])return;
    cal.getEvents().filter(e=>e.extendedProps.type==='reservation').forEach(ev=>{
      overviewCal.addEvent({
        title:ev.extendedProps.owner,start:ev.start,end:ev.end,
        backgroundColor:PRINTER_COLORS_ALPHA[i],borderColor:PRINTER_COLORS[i],textColor:PRINTER_COLORS[i],
        extendedProps:{printerIdx:i,owner:ev.extendedProps.owner}
      });
    });
  });
}

// ── CALENDARS ──
function makeCalendar(idx){
  const el=document.getElementById('cal-'+idx),printerName=PRINTER_NAMES[idx];
  function hasConflict(skipEv,start,end){
    return calendars[idx].getEvents().some(ev=>{
      if(ev===skipEv||ev.extendedProps.type!=='reservation')return false;
      if(currentUser.role==='admin')return false;
      const eS=ev.start,eE=ev.end||new Date(ev.start.getTime()+30*60000);
      if(ev.extendedProps.owner!==currentUser.name)return start<eE&&end>eS;
      return false;
    });
  }
  const cal=new FullCalendar.Calendar(el,{
    initialView:'timeGridWeek',selectable:currentUser.role!=='read',editable:currentUser.role!=='read',
    eventResizableFromStart:true,height:'auto',allDaySlot:false,
    slotMinTime:'08:00:00',slotMaxTime:'18:00:00',hiddenDays:[0,6],nowIndicator:true,
    headerToolbar:{left:'prev,next today',center:'title',right:'timeGridWeek,timeGridDay'},events:[],

    select:async function(info){
      if(currentUser.role==='read'){toast('Read-only access.');return;}
      const timeStr=info.start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      const mins=await durationModal(printerName,timeStr);if(!mins)return;
      const end=new Date(info.start.getTime()+mins*60000);
      if(hasConflict(null,info.start,end)){toast('⚠ That slot conflicts with an existing booking.');return;}
      cal.addEvent({title:currentUser.name,start:info.start,end,extendedProps:{type:'reservation',owner:currentUser.name}});
      toast(`✓ Booked ${printerName} for ${mins} min`);saveBookings();updateAllStats();refreshOverview();
    },
    eventDrop:async function(info){
      const ev=info.event;
      if(currentUser.role==='read'){info.revert();return;}
      if(currentUser.role!=='admin'&&ev.extendedProps.owner!==currentUser.name){toast('You can only move your own reservations.');info.revert();return;}
      const end=ev.end||new Date(ev.start.getTime()+30*60000);
      if(hasConflict(ev,ev.start,end)){const ok=await choiceModal({title:'Conflict',message:'This overlaps another booking. Move anyway?',confirmText:'Move Anyway',cancelText:'Undo'});if(!ok){info.revert();return;}}
      toast('Reservation moved.');saveBookings();updateAllStats();refreshOverview();
    },
    eventResize:async function(info){
      const ev=info.event;
      if(currentUser.role==='read'){info.revert();return;}
      if(currentUser.role!=='admin'&&ev.extendedProps.owner!==currentUser.name){toast('You can only resize your own reservations.');info.revert();return;}
      const end=ev.end||new Date(ev.start.getTime()+30*60000);
      if(hasConflict(ev,ev.start,end)){const ok=await choiceModal({title:'Conflict',message:'This resize overlaps another booking. Keep it?',confirmText:'Keep',cancelText:'Undo'});if(!ok){info.revert();return;}}
      toast('Reservation updated.');saveBookings();updateAllStats();refreshOverview();
    },
    eventClick:async function(info){
      const ev=info.event;
      if(currentUser.role==='read'){toast(`Booked by ${ev.extendedProps.owner}`);return;}
      if(currentUser.role!=='admin'&&ev.extendedProps.owner!==currentUser.name){toast('You can only delete your own reservations.');return;}
      const confirmed=await deleteModal(`${ev.title}'s reservation`);
      if(confirmed){addToHistory({printer:printerName,owner:ev.extendedProps.owner,start:ev.start.toISOString(),end:ev.end?ev.end.toISOString():null,status:'deleted',deletedAt:new Date().toISOString()});ev.remove();toast('Deleted.');saveBookings();updateAllStats();refreshOverview();}
    }
  });
  cal.render();return cal;
}

function initCalendars(){
  for(let i=0;i<4;i++)calendars.push(makeCalendar(i));
  loadBookings();updateAllStats();setInterval(updateAllStats,60000);
}
</script>
</body>
</html>

